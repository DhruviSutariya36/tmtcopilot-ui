<!doctype html>
<html>
<head>
    <title>Processing...</title>
    <script>
        async function pollStatus() {
            const statusUrl = "{{ status_url }}";
            try {
                const response = await fetch(statusUrl);
                const data = await response.json();

                if (data.runtimeStatus === "Completed") {
                    document.getElementById("status").innerText = "✅ Processing complete!";
                    if (data.output && data.output.enriched_blob_url) {
                        document.getElementById("download-form").style.display = "block";
                        document.getElementById("blob_url").value = data.output.enriched_blob_url;
                    }
                } else if (["Failed", "Terminated"].includes(data.runtimeStatus)) {
                    document.getElementById("status").innerText = "❌ Processing failed.";
                } else {
                    document.getElementById("status").innerText = "⏳ Still processing...";
                    setTimeout(pollStatus, 5000);
                }
            } catch (err) {
                document.getElementById("status").innerText = "Error fetching status.";
            }
        }

        window.onload = pollStatus;
    </script>
</head>
<body>
    <h2>Processing File</h2>
    <p id="status">Waiting for results...</p>

    <form id="download-form" method="get" action="{{ download_url }}" style="display:none;">
        <input type="hidden" id="blob_url" name="blob_url" value="">
        <button type="submit">Download CSV</button>
    </form>
</body>
</html>
