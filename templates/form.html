<script>
    const form = document.getElementById("uploadForm");
    const spinner = document.getElementById("spinner-overlay");
    const resultSection = document.getElementById("resultSection");
    const blobInput = document.getElementById("blob_url");
    const filenameInput = document.getElementById("filename");
    
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        spinner.style.display = "flex";
    
        const formData = new FormData(form);
    
        try {
            // POST to Flask route (which calls Durable Function)
            const starterResp = await fetch("{{ url_for('index') }}", {
                method: "POST",
                body: formData
            });
            if (!starterResp.ok) throw new Error("Failed to start enrichment");
    
            const starterData = await starterResp.json();
            let statusUrl = starterData.statusQueryGetUri;
            if (!statusUrl) throw new Error("No status URL returned");
    
            // Poll every 10 seconds
            let enrichmentCompleted = false;
            while (!enrichmentCompleted) {
                const statusResp = await fetch(statusUrl);
                const statusData = await statusResp.json();
                const runtimeStatus = statusData.runtimeStatus;
                console.log("Orchestration status:", runtimeStatus);
    
                if (runtimeStatus === "Completed") {
                    enrichmentCompleted = true;
                    const output = statusData.output || {};
                    blobInput.value = output.enriched_blob_url;
                    // Set filename to "enriched_" + original filename
                    filenameInput.value = "enriched_" + formData.get("file").name;
                    spinner.style.display = "none";
                    resultSection.style.display = "block";
                } else if (runtimeStatus === "Failed" || runtimeStatus === "Terminated") {
                    enrichmentCompleted = true;
                    spinner.style.display = "none";
                    alert("Durable Function failed: " + runtimeStatus);
                } else {
                    await new Promise(resolve => setTimeout(resolve, 10000)); // 10s delay
                }
            }
    
        } catch (err) {
            spinner.style.display = "none";
            alert("Error: " + err.message);
            console.error(err);
        }
    });
    </script>
    